<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iCub-main: The PeriodicThread Class</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iCub-main
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The PeriodicThread Class </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this tutorial we show how to write a control loop using threads.</p>
<p>Before you read this tutorial you should at least get accustomed with motor interfaces as described in <a class="el" href="icub_motor_control_tutorial.html">Getting accustomed with motor interfaces</a> (material in <a class="el" href="icub_basic_image_processing.html">Basic Image Processing</a> might also be useful).</p>
<h1><a class="anchor" id="sec_intro"></a>
Introduction</h1>
<p>Often, you want to perform different tasks in parallel or with a given periodicity. Modern operating system provides support for writing threads. Threads are functions that are executed by the CPU in parallel. The use of threads is recommended in machines with multiple cores.</p>
<p>YARP supports threads with two main classes: yarp::os::Thread and yarp::os::PeriodicThread.</p>
<p>In this tutorial we show how to use the yarp::os::PeriodicThread class to write a control loop with a certain periodicity.</p>
<h1><a class="anchor" id="sec_yourownthread"></a>
Writing your own thread</h1>
<p>To write a thread you have to derive a new class from yarp::os::PeriodicThread. In doing so you can to explicitly call the PeriodicThread constructor and pass to it the periodicity of the thread (in seconds).</p>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code" href="classControlThread.html">ControlThread</a>: <span class="keyword">public</span> yarp::os::PeriodicThread</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">     <a class="code" href="classControlThread.html#a8eec97db0371fd6e6909e2befbee9483">ControlThread</a>(<span class="keywordtype">double</span> period):PeriodicThread(period)</div>
<div class="line">    {...}</div>
<div class="line">};</div>
<div class="ttc" id="aclassControlThread_html"><div class="ttname"><a href="classControlThread.html">ControlThread</a></div><div class="ttdef"><b>Definition:</b> <a href="tutorial__periodic__thread_8cpp_source.html#l00020">tutorial_periodic_thread.cpp:21</a></div></div>
<div class="ttc" id="aclassControlThread_html_a8eec97db0371fd6e6909e2befbee9483"><div class="ttname"><a href="classControlThread.html#a8eec97db0371fd6e6909e2befbee9483">ControlThread::ControlThread</a></div><div class="ttdeci">ControlThread(double period)</div><div class="ttdef"><b>Definition:</b> <a href="tutorial__periodic__thread_8cpp_source.html#l00029">tutorial_periodic_thread.cpp:29</a></div></div>
</div><!-- fragment --><p>We add three methods to the class: run(), threadInit() and threadRelease(). The run() function will be called periodically every "period" seconds. threadInit() is called once when the thread starts (before run is executed). Finally the thread executes threadRelease() when closing.</p>
<p>We would like to write a thread that periodically check the encoders and alternates two velocity commands. This thread will control for example the head of the robot. We need a PolyDriver to store the robot device (see <a class="el" href="icub_motor_control_tutorial.html">Getting accustomed with motor interfaces</a>), and an instance of IEncoders and IVelocityControl.</p>
<div class="fragment"><div class="line">PolyDriver dd;</div>
<div class="line">IVelocityControl *ivel;</div>
<div class="line">IEncoders        *iencs;</div>
</div><!-- fragment --><p>We also prepare two vectors of to store the encoders and one to store the commands we will send to the controller. A counter will allow us to alternate between two commands.</p>
<div class="fragment"><div class="line">Vector encoders;</div>
<div class="line">Vector <a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>;</div>
<div class="line"><span class="keywordtype">int</span> count;</div>
<div class="ttc" id="adiagnostics__buttons_8cpp_html_aaad2f6556489c51f2c24302e2cb4188a"><div class="ttname"><a href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a></div><div class="ttdeci">void commands(void)</div><div class="ttdef"><b>Definition:</b> <a href="diagnostics__buttons_8cpp_source.html#l00085">diagnostics_buttons.cpp:85</a></div></div>
</div><!-- fragment --><p>Now we can implement the bool threadInit() function. First we will create an instance of the polydriver and configure it to connect to the head.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> threadInit()</div>
<div class="line">{</div>
<div class="line">      <span class="comment">/* initialize here variables */</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;ControlThread:starting\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      Property options;</div>
<div class="line">      options.put(<span class="stringliteral">&quot;device&quot;</span>, <span class="stringliteral">&quot;remote_controlboard&quot;</span>);</div>
<div class="line">      options.put(<span class="stringliteral">&quot;local&quot;</span>, <span class="stringliteral">&quot;/local/head&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* substitute icubSim with icub for use with the real robot */</span></div>
<div class="line">      options.put(<span class="stringliteral">&quot;remote&quot;</span>, <span class="stringliteral">&quot;/icubSim/head&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      dd.open(options);</div>
</div><!-- fragment --><p>at this point we have to check that the device is valid and really offers the interfaces we need:</p>
<div class="fragment"><div class="line">dd.view(iencs);</div>
<div class="line">dd.view(ivel);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> ( (!iencs) || (!ivel) )</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
</div><!-- fragment --><p>Note: it is important to return false if something does not go as expected in the initialization. This will prevent the thread from running.</p>
<p>Now we can get the number of joints, resize the vectors and initialize the acceleration of the motors:</p>
<div class="fragment"><div class="line">      <span class="keywordtype">int</span> joints;</div>
<div class="line"> </div>
<div class="line">      iencs-&gt;getAxes(&amp;joints);</div>
<div class="line"> </div>
<div class="line">      encoders.resize(joints);</div>
<div class="line">      <a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>.resize(joints);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>=10000;</div>
<div class="line"> </div>
<div class="line">      ivel-&gt;setRefAccelerations(<a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>.data());</div>
<div class="line">      count=0;</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">} <span class="comment">/* the function threadInit() finishes here */</span></div>
</div><!-- fragment --><p>It is now time to implement the run function. This function is the thread's body, and perform the real control task:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> run()</div>
<div class="line">{</div>
<div class="line">      <span class="comment">/* reads encoders */</span></div>
<div class="line">      iencs-&gt;getEncoders(encoders.data());</div>
<div class="line"> </div>
<div class="line">      count++;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* alternates two commands */</span></div>
<div class="line">      <span class="keywordflow">if</span> (count%2)</div>
<div class="line">          <a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>=5;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">          <a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>=-5;</div>
<div class="line"> </div>
<div class="line">      ivel-&gt;velocityMove(<a class="code" href="diagnostics__buttons_8cpp.html#aaad2f6556489c51f2c24302e2cb4188a">commands</a>.data());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* print something at each iteration so we see when the thread runs */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>When the thread will quit, we have to make sure that we stop the head and release used resources. We put this code in threadRelease():</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> threadRelease()</div>
<div class="line">{</div>
<div class="line">      printf(<span class="stringliteral">&quot;ControlThread:stopping the robot\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      ivel-&gt;stop();</div>
<div class="line"> </div>
<div class="line">      dd.close();</div>
<div class="line"> </div>
<div class="line">      printf(<span class="stringliteral">&quot;Done, goodbye from ControlThread\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="sec_runningthethread"></a>
Running the thread</h1>
<p>Now that we have implemented our thread we can run it. This can be done easily in a few steps:</p>
<p>Create an instance of the thread, we use here 4s of period: </p><div class="fragment"><div class="line"><a class="code" href="classControlThread.html">ControlThread</a> myThread(4.0);</div>
</div><!-- fragment --><p>Start the thread: </p><div class="fragment"><div class="line">myThread.start();</div>
</div><!-- fragment --><p>The thread is created and start to execute initThread(); if the latter returns true, the thread executes run() periodically. In the meanwhile the main thread can perform other operations. In this example we do not do anything smarter than just sitting idle for 10 seconds:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="icub-main_2src_2tools_2canBusSniffer_2canBusSnifferV5_2main_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a>=<span class="keyword">false</span>;</div>
<div class="line"><span class="keywordtype">double</span> startTime=Time::now();</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> SOME_TIME=10;</div>
<div class="line"><span class="keywordflow">while</span>(!<a class="code" href="icub-main_2src_2tools_2canBusSniffer_2canBusSnifferV5_2main_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> ((Time::now()-startTime)&gt;SOME_TIME)</div>
<div class="line">        <a class="code" href="icub-main_2src_2tools_2canBusSniffer_2canBusSnifferV5_2main_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a>=<span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aicub-main_2src_2tools_2canBusSniffer_2canBusSnifferV5_2main_8cpp_html_a1d39aac66e12dae50a24cd7a9100ef33"><div class="ttname"><a href="icub-main_2src_2tools_2canBusSniffer_2canBusSnifferV5_2main_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a></div><div class="ttdeci">bool done</div><div class="ttdef"><b>Definition:</b> <a href="icub-main_2src_2tools_2canBusSniffer_2canBusSnifferV5_2main_8cpp_source.html#l00042">main.cpp:42</a></div></div>
</div><!-- fragment --><p>To stop the thread we call:</p>
<div class="fragment"><div class="line">myThread.stop();</div>
</div><!-- fragment --><p>stop() blocks and waits that the thread performs the last run() function, and threadRelease(), after which we can safely return.</p>
<p>Full working code of this tutorial is available here: <a class="el" href="tutorial__periodic__thread_8cpp.html">src/periodicThread/tutorial_periodic_thread.cpp</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 26 2024 16:02:19 for iCub-main by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
