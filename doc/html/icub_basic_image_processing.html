<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iCub-main: Basic Image Processing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iCub-main
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Basic Image Processing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sec_goal"></a>
Goal</h1>
<p>To choose a visual target and fixate it. For simplicity, the target shall be "blueish stuff", and we'll work on the simulator.</p>
<p>So if the simulated robot sees something like this:</p>
<div class="image">
<img src="see_ball.jpg" alt=""/>
</div>
<div class="image">
<img src="fixate_ball.jpg" alt=""/>
</div>
<h1><a class="anchor" id="sec_programs"></a>
Programs to write</h1>
<p>Let's make two programs:</p><ul>
<li>find_location.cpp, this will look at the input from a camera and decide what location within it looks interesting</li>
<li>look_at_location.cpp, this will take an image location and try to move the camera to look towards it</li>
</ul>
<p>For the first program, find_location, we can use any camera. For the second, we need to use the camera on the robot or the robot simulator. With the simulator, use the "world on" flag in the activation configuration file (conf/iCub_parts_activation.ini) so that the robot has a blue ball on a table in front of it. At the time of writing, you can move the robot's eyes down to see the ball by running: </p><div class="fragment"><div class="line"><a class="code" href="namespaceyarp.html">yarp</a> rpc /icubSim/head/rpc:i</div>
<div class="ttc" id="anamespaceyarp_html"><div class="ttname"><a href="namespaceyarp.html">yarp</a></div><div class="ttdoc">Copyright (C) 2008 RobotCub Consortium.</div><div class="ttdef"><b>Definition:</b> <a href="DebugInterfaces_8h_source.html#l00051">DebugInterfaces.h:51</a></div></div>
</div><!-- fragment --><p><br  />
</p>
<p>and typing: </p><div class="fragment"><div class="line">set pos 0 -60</div>
</div><!-- fragment --><p>(this should turn the eyes 60 degrees downward).</p>
<h1><a class="anchor" id="sec_find_location"></a>
Find Location</h1>
<p>In YARP, camera images are sent from one program to another using ports. In C++, we can create a port for reading or writing images like this:</p>
<div class="fragment"><div class="line">BufferedPort&lt;ImageOf&lt;PixelRgb&gt; &gt; port;</div>
</div><!-- fragment --><p>This means "make a port with buffering for sending/receiving images in RGB format".</p>
<p>Here's a basic program to get images repeatedly: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="comment">/* Get all OS and signal processing YARP classes */</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/os/all.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/sig/all.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>yarp::os;</div>
<div class="line"><span class="keyword">using namespace </span>yarp::sig;</div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line">  Network <a class="code" href="namespaceyarp.html">yarp</a>; <span class="comment">// set up yarp</span></div>
<div class="line">  BufferedPort&lt;ImageOf&lt;PixelRgb&gt; &gt; imagePort;  <span class="comment">// make a port for reading images</span></div>
<div class="line">  imagePort.open(<span class="stringliteral">&quot;/tutorial/image/in&quot;</span>);  <span class="comment">// give the port a name</span></div>
<div class="line">  <span class="keywordflow">while</span> (1) { </div>
<div class="line">    ImageOf&lt;PixelRgb&gt; *image = imagePort.read();  <span class="comment">// read an image</span></div>
<div class="line">    <span class="keywordflow">if</span> (image!=NULL) { <span class="comment">// check we actually got something</span></div>
<div class="line">       printf(<span class="stringliteral">&quot;We got an image of size %dx%d\n&quot;</span>, image-&gt;width(), image-&gt;height());</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aicub-main_2src_2core_2emotionInterface_2main_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition:</b> <a href="icub-main_2src_2core_2emotionInterface_2main_8cpp_source.html#l00031">main.cpp:31</a></div></div>
</div><!-- fragment --><p>You can compile this any way you like. One quick way to do it is to go into the directory where you saved this program (in a file called for example "find_location.cpp") and type:</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceyarp.html">yarp</a> cmake</div>
</div><!-- fragment --><p><br  />
</p>
<p>This creates a basic CMakeLists.txt project file that is good enough to compile most simple programs. Run cmake in this directory, and compile. You will get a program called "yarpy" (you can and should change this name by editing the CMakeLists.txt file). If you run it, you should see a port called "/tutorial/image/in" being created. <br  />
</p>
<p>You can then connect an image source to that port using:</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceyarp.html">yarp</a> connect &lt;name of image port&gt; /tutorial/image/in</div>
</div><!-- fragment --><p>for example, for the simulator, it would be something like: </p><div class="fragment"><div class="line"><a class="code" href="namespaceyarp.html">yarp</a> connect /icubSim/cam/left /tutorial/image/in</div>
</div><!-- fragment --><p> you should now see messages like this: </p><pre class="fragment">  We got an image of size 320x240
  We got an image of size 320x240
  We got an image of size 320x240
  ...
</pre><p>Now let's extend our program a bit, to pick up blueish objects (for example): </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="comment">// Get all OS and signal processing YARP classes</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/os/all.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/sig/all.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>yarp::os;</div>
<div class="line"><span class="keyword">using namespace </span>yarp::sig;</div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line">  Network <a class="code" href="namespaceyarp.html">yarp</a>; <span class="comment">// set up yarp</span></div>
<div class="line">  BufferedPort&lt;ImageOf&lt;PixelRgb&gt; &gt; imagePort;  <span class="comment">// make a port for reading images</span></div>
<div class="line">  imagePort.open(<span class="stringliteral">&quot;/tutorial/image/in&quot;</span>);  <span class="comment">// give the port a name</span></div>
<div class="line">  <span class="keywordflow">while</span> (1) { <span class="comment">// repeat forever</span></div>
<div class="line">    ImageOf&lt;PixelRgb&gt; *image = imagePort.read();  <span class="comment">// read an image</span></div>
<div class="line">    <span class="keywordflow">if</span> (image!=NULL) { <span class="comment">// check we actually got something</span></div>
<div class="line">       printf(<span class="stringliteral">&quot;We got an image of size %dx%d\n&quot;</span>, image-&gt;width(), image-&gt;height());</div>
<div class="line">       <span class="keywordtype">double</span> xMean = 0;</div>
<div class="line">       <span class="keywordtype">double</span> yMean = 0;</div>
<div class="line">       <span class="keywordtype">int</span> ct = 0;</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>=0; <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>&lt;image-&gt;width(); <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>++) {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>=0; <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>&lt;image-&gt;height(); <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>++) {</div>
<div class="line">           PixelRgb&amp; pixel = image-&gt;pixel(<a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>,<a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>);</div>
<div class="line">           <span class="comment">// very simple test for blueishness</span></div>
<div class="line">           <span class="comment">// make sure blue level exceeds red and green by a factor of 2</span></div>
<div class="line">           <span class="keywordflow">if</span> (pixel.b&gt;pixel.r*1.2+10 &amp;&amp; pixel.b&gt;pixel.g*1.2+10) {</div>
<div class="line">            <span class="comment">// there&#39;s a blueish pixel at (x,y)!</span></div>
<div class="line">            <span class="comment">// let&#39;s find the average location of these pixels</span></div>
<div class="line">            xMean += <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>;</div>
<div class="line">            yMean += <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>;</div>
<div class="line">            ct++;</div>
<div class="line">           }</div>
<div class="line">         }</div>
<div class="line">       }</div>
<div class="line">       <span class="keywordflow">if</span> (ct&gt;0) {</div>
<div class="line">         xMean /= ct;</div>
<div class="line">         yMean /= ct;</div>
<div class="line">       }</div>
<div class="line">       <span class="keywordflow">if</span> (ct&gt;(image-&gt;width()/20)*(image-&gt;height()/20)) {</div>
<div class="line">         printf(<span class="stringliteral">&quot;Best guess at blue target: %g %g\n&quot;</span>, xMean, yMean);</div>
<div class="line">       }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="acompute__ekf__sym_8m_html_abe119338ba11d7fd166333a3941bc2c4"><div class="ttname"><a href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a></div><div class="ttdeci">x</div><div class="ttdef"><b>Definition:</b> <a href="compute__ekf__sym_8m_source.html#l00021">compute_ekf_sym.m:21</a></div></div>
<div class="ttc" id="ashow__eyes__axes_8m_html_a2fb1c5cf58867b5bbc9a1b145a86f3a0"><div class="ttname"><a href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a></div><div class="ttdeci">y</div><div class="ttdef"><b>Definition:</b> <a href="show__eyes__axes_8m_source.html#l00021">show_eyes_axes.m:21</a></div></div>
</div><!-- fragment --><p>Now that we have a target, let's output it. We can output it as a YARP Vector for example, using a port like this:</p>
<div class="fragment"><div class="line">BufferedPort&lt;Vector&gt; targetPort;</div>
</div><!-- fragment --><p>We add some lines at the beginning of the program:</p>
<div class="fragment"><div class="line">Network <a class="code" href="namespaceyarp.html">yarp</a>;</div>
<div class="line">BufferedPort&lt;ImageOf&lt;PixelRgb&gt; &gt; imagePort;</div>
<div class="line">BufferedPort&lt;Vector&gt; targetPort;  <span class="comment">// ADD THIS LINE</span></div>
<div class="line">targetPort.open(<span class="stringliteral">&quot;/tutorial/target/out&quot;</span>);  <span class="comment">// ADD THIS LINE</span></div>
</div><!-- fragment --><p>and then when we know what our target is, we send it:</p>
<div class="fragment"><div class="line">printf(<span class="stringliteral">&quot;Best guess at blue target: %g %g\n&quot;</span>, xMean, yMean);</div>
<div class="line">Vector&amp; v = targetPort.prepare();</div>
<div class="line">v.resize(3);</div>
<div class="line">v[0] = xMean;</div>
<div class="line">v[1] = yMean;</div>
<div class="line">v[2] = 1;       <span class="comment">// a confidence value, always good practice to add.  In this case, we pretend to be very confident</span></div>
<div class="line">targetPort.write();  <span class="comment">// send our data</span></div>
</div><!-- fragment --><p>When no target is selected, it is still good to send output, to say explicitly that there is no output rather than just remaining silent (which is hard to distinguish from the program just stopping or not running).</p>
<div class="fragment"><div class="line"><span class="comment">/* dd this for the condition where no target is picked */</span></div>
<div class="line">Vector&amp; v = targetPort.prepare();</div>
<div class="line">v.resize(3);</div>
<div class="line">v[0] = 0;</div>
<div class="line">v[1] = 0;</div>
<div class="line">v[2] = 0;</div>
<div class="line">targetPort.write();  <span class="comment">// send our data</span></div>
</div><!-- fragment --><p>Now we can read from this port (just to test) with yarp read: </p><div class="fragment"><div class="line"><a class="code" href="namespaceyarp.html">yarp</a> <a class="code" href="namespaceeth_1_1parser.html#a8ec58da625146082584ad1a365bdd0e5">read</a> ... /tutorial/target/<a class="code" href="sine_8m.html#a2a89187d8e8e8fba509ef9ab5f815d88">out</a></div>
<div class="ttc" id="anamespaceeth_1_1parser_html_a8ec58da625146082584ad1a365bdd0e5"><div class="ttname"><a href="namespaceeth_1_1parser.html#a8ec58da625146082584ad1a365bdd0e5">eth::parser::read</a></div><div class="ttdeci">bool read(yarp::os::Searchable &amp;cfgtotal, pc104Data &amp;pc104data)</div><div class="ttdef"><b>Definition:</b> <a href="ethParser_8cpp_source.html#l00092">ethParser.cpp:92</a></div></div>
<div class="ttc" id="asine_8m_html_a2a89187d8e8e8fba509ef9ab5f815d88"><div class="ttname"><a href="sine_8m.html#a2a89187d8e8e8fba509ef9ab5f815d88">out</a></div><div class="ttdeci">out</div><div class="ttdef"><b>Definition:</b> <a href="sine_8m_source.html#l00008">sine.m:8</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="sec_look_at"></a>
Look at Location</h1>
<p>Now let's write a separate program that takes the target location computed in find_location.cpp and drives the real of simulated camera to look towards that location. First, we need to read our vector: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/os/all.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/sig/all.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>std;</div>
<div class="line"><span class="keyword">using namespace </span>yarp::os;</div>
<div class="line"><span class="keyword">using namespace </span>yarp::sig;</div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line">  Network <a class="code" href="namespaceyarp.html">yarp</a>; <span class="comment">// set up yarp</span></div>
<div class="line">  BufferedPort&lt;Vector&gt; targetPort;</div>
<div class="line">  targetPort.open(<span class="stringliteral">&quot;/tutorial/target/in&quot;</span>);</div>
<div class="line">  <span class="keywordflow">while</span> (1) { <span class="comment">// repeat forever</span></div>
<div class="line">    Vector *target = targetPort.read();  <span class="comment">// read a target</span></div>
<div class="line">    <span class="keywordflow">if</span> (target!=NULL) { <span class="comment">// check we actually got something</span></div>
<div class="line">       printf(<span class="stringliteral">&quot;We got a vector of size %d\n&quot;</span>, target-&gt;size());</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}  </div>
</div><!-- fragment --><p>Compile using the same method as before. If we run the two programs, connect an image source to the first one, and do:</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceyarp.html">yarp</a> connect /tutorial/target/<a class="code" href="sine_8m.html#a2a89187d8e8e8fba509ef9ab5f815d88">out</a> /tutorial/target/in</div>
</div><!-- fragment --><p>We should see messages like this: </p><pre class="fragment">  We got a vector of size 3
  We got a vector of size 3
  ...
</pre><p>Let's change our message from: </p><div class="fragment"><div class="line">printf(<span class="stringliteral">&quot;We got a vector of size %d\n&quot;</span>, target-&gt;size());</div>
</div><!-- fragment --><p>to: </p><div class="fragment"><div class="line">printf(<span class="stringliteral">&quot;We got a vector containing&quot;</span>);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;target-&gt;size(); i++) {</div>
<div class="line">  printf(<span class="stringliteral">&quot; %g&quot;</span>, (*target)[i]);</div>
<div class="line">}</div>
<div class="line">printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
</div><!-- fragment --><p>We should see messages like this: </p><pre class="fragment">  We got a vector containing 234.459 191.892 1   
  We got a vector containing 234.459 191.892 1   
  We got a vector containing 234.459 191.892 1   
  ...
</pre><p> or </p><pre class="fragment">  We got a vector containing 0 0 0
  We got a vector containing 0 0 0
  We got a vector containing 0 0 0
</pre><p>if no target is visible.</p>
<p>Now we need to drive the motors (see <a class="el" href="icub_motor_control_tutorial.html">Getting accustomed with motor interfaces</a>). For this, we need the YARP device classes, so we add another header file at the start of our program:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;yarp/dev/all.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceyarp_1_1dev.html">yarp::dev</a>;</div>
<div class="ttc" id="anamespaceyarp_1_1dev_html"><div class="ttname"><a href="namespaceyarp_1_1dev.html">yarp::dev</a></div><div class="ttdef"><b>Definition:</b> <a href="DebugInterfaces_8h_source.html#l00052">DebugInterfaces.h:52</a></div></div>
</div><!-- fragment --><p>We connect to the simulator head: </p><div class="fragment"><div class="line">Property options;</div>
<div class="line">options.put(<span class="stringliteral">&quot;device&quot;</span>, <span class="stringliteral">&quot;remote_controlboard&quot;</span>);</div>
<div class="line">options.put(<span class="stringliteral">&quot;local&quot;</span>, <span class="stringliteral">&quot;/tutorial/motor/client&quot;</span>);</div>
<div class="line">options.put(<span class="stringliteral">&quot;remote&quot;</span>, <span class="stringliteral">&quot;/icubSim/head&quot;</span>);</div>
<div class="line">PolyDriver robotHead(options);</div>
<div class="line"><span class="keywordflow">if</span> (!robotHead.isValid()) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Cannot connect to robot head\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line">IControlMode     *mod;</div>
<div class="line">IPositionControl *pos;</div>
<div class="line">IVelocityControl *vel;</div>
<div class="line">IEncoders *enc;</div>
<div class="line">robotHead.view(mod);</div>
<div class="line">robotHead.view(pos);</div>
<div class="line">robotHead.view(vel);</div>
<div class="line">robotHead.view(enc);</div>
<div class="line"><span class="keywordflow">if</span> (mode==NULL || pos==NULL || vel==NULL || enc==NULL) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Cannot get interface to robot head\n&quot;</span>);</div>
<div class="line">  robotHead.close();</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a> = 0;</div>
<div class="line">pos-&gt;getAxes(&amp;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line">Vector setpoints;</div>
<div class="line">setpoints.resize(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// enable velocity control mode</span></div>
<div class="line">vector&lt;int&gt; modes(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>,VOCAB_CM_VELOCITY);</div>
<div class="line">mod-&gt;setControlModes(modes.data());</div>
<div class="ttc" id="aicub-main_2src_2tools_2simpleClient_2main_8cpp_html_aac40ef34e7573177f3e908c5195594a6"><div class="ttname"><a href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a></div><div class="ttdeci">int jnts</div><div class="ttdef"><b>Definition:</b> <a href="icub-main_2src_2tools_2simpleClient_2main_8cpp_source.html#l00060">main.cpp:60</a></div></div>
</div><!-- fragment --><p>Finally let's send a dumb command just to test: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (target!=NULL) {</div>
<div class="line">  ...</div>
<div class="line">  <span class="comment">// prepare command</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">    setpoints[i] = 0;</div>
<div class="line">  }</div>
<div class="line">  setpoints[3] = 5; <span class="comment">// common tilt of eyes</span></div>
<div class="line">  setpoints[4] = 5; <span class="comment">// common version of eyes</span></div>
<div class="line">  vel-&gt;velocityMove(setpoints.data());</div>
<div class="line">}</div>
</div><!-- fragment --><p>The robot head should move to an extreme "diagonal" location. This helps us figure out which signs for velocity move the robot's view in which direction. Here's an actual working tracker: </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a> = (*target)[0];</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a> = (*target)[1];</div>
<div class="line"><span class="keywordtype">double</span> conf = (*target)[2];</div>
<div class="line"> </div>
<div class="line"><a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a> -= 320/2;  <span class="comment">// center of image should mean no motion</span></div>
<div class="line"><a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a> -= 240/2;  <span class="comment">// (we should be passing image size in our message)</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> vx = <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>*0.1;  <span class="comment">// don&#39;t move too fast</span></div>
<div class="line"><span class="keywordtype">double</span> vy = -<a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>*0.1;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// prepare command</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">  setpoints[i] = 0;</div>
<div class="line">}</div>
<div class="line">   </div>
<div class="line"><span class="keywordflow">if</span> (conf&gt;0.5) {</div>
<div class="line">  setpoints[3] = vy;</div>
<div class="line">  setpoints[4] = vx;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  setpoints[3] = 0;</div>
<div class="line">  setpoints[4] = 0;</div>
<div class="line">}</div>
<div class="line">vel-&gt;velocityMove(setpoints.data());</div>
</div><!-- fragment --><p>The simulated robot should now successfully center the blue ball on the table, once it catches sight of it at all.</p>
<p>Complete code for finding the blue ball:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;stdio.h&gt;</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment">/* Get all OS and signal processing YARP classes */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"> #include &lt;yarp/os/all.h&gt;</span></div>
<div class="line"><span class="preprocessor"> #include &lt;yarp/sig/all.h&gt;</span></div>
<div class="line"> <span class="keyword">using namespace </span>yarp::os;</div>
<div class="line"> <span class="keyword">using namespace </span>yarp::sig;</div>
<div class="line"> <span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line"> Network <a class="code" href="namespaceyarp.html">yarp</a>; <span class="comment">// set up yarp</span></div>
<div class="line"> BufferedPort&lt;ImageOf&lt;PixelRgb&gt; &gt; imagePort;  <span class="comment">// make a port for reading images</span></div>
<div class="line"> BufferedPort&lt;Vector&gt; targetPort;</div>
<div class="line"> imagePort.open(<span class="stringliteral">&quot;/tutorial/image/in&quot;</span>);  <span class="comment">// give the port a name</span></div>
<div class="line"> targetPort.open(<span class="stringliteral">&quot;/tutorial/target/out&quot;</span>);</div>
<div class="line"> Network::connect(<span class="stringliteral">&quot;/icubSim/cam/left&quot;</span>,<span class="stringliteral">&quot;/tutorial/image/in&quot;</span>);</div>
<div class="line"> <span class="keywordflow">while</span> (1) { <span class="comment">// repeat forever</span></div>
<div class="line">   ImageOf&lt;PixelRgb&gt; *image = imagePort.read();  <span class="comment">// read an image</span></div>
<div class="line">   <span class="keywordflow">if</span> (image!=NULL) { <span class="comment">// check we actually got something</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;We got an image of size %dx%d\n&quot;</span>, image-&gt;width(), image-&gt;height());</div>
<div class="line">      <span class="keywordtype">double</span> xMean = 0;</div>
<div class="line">      <span class="keywordtype">double</span> yMean = 0;</div>
<div class="line">      <span class="keywordtype">int</span> ct = 0;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>=0; <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>&lt;image-&gt;width(); <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>++) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>=0; <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>&lt;image-&gt;height(); <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>++) {</div>
<div class="line">          PixelRgb&amp; pixel = image-&gt;pixel(<a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>,<a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>);</div>
<div class="line">          <span class="comment">/* very simple test for blueishness */</span></div>
<div class="line">          <span class="comment">/* make sure blue level exceeds red and green by a factor of 2 */</span></div>
<div class="line">          <span class="keywordflow">if</span> (pixel.b&gt;pixel.r*1.2+10 &amp;&amp; pixel.b&gt;pixel.g*1.2+10) {</div>
<div class="line">           <span class="comment">/* there&#39;s a blueish pixel at (x,y)! */</span></div>
<div class="line">           <span class="comment">/* let&#39;s find the average location of these pixels */</span></div>
<div class="line">           xMean += <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>;</div>
<div class="line">           yMean += <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>;</div>
<div class="line">           ct++;</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (ct&gt;0) {</div>
<div class="line">        xMean /= ct;</div>
<div class="line">        yMean /= ct;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (ct&gt;(image-&gt;width()/20)*(image-&gt;height()/20)) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Best guess at blue target: %g %g\n&quot;</span>, xMean, yMean);</div>
<div class="line">        Vector&amp; target = targetPort.prepare();</div>
<div class="line">        target.resize(3);</div>
<div class="line">        target[0] = xMean;</div>
<div class="line">        target[1] = yMean;</div>
<div class="line">        target[2] = 1;</div>
<div class="line">        targetPort.write();</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        Vector&amp; target = targetPort.prepare();</div>
<div class="line">        target.resize(3);</div>
<div class="line">        target[0] = 0;</div>
<div class="line">        target[1] = 0;</div>
<div class="line">        target[2] = 0;</div>
<div class="line">        targetPort.write();</div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line"> }</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Complete look_at_location.cpp:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/os/all.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/sig/all.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/dev/all.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>std;</div>
<div class="line"><span class="keyword">using namespace </span>yarp::os;</div>
<div class="line"><span class="keyword">using namespace </span>yarp::sig;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceyarp_1_1dev.html">yarp::dev</a>;</div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line">  Network <a class="code" href="namespaceyarp.html">yarp</a>; <span class="comment">// set up yarp</span></div>
<div class="line">  BufferedPort&lt;Vector&gt; targetPort;</div>
<div class="line">  targetPort.open(<span class="stringliteral">&quot;/tutorial/target/in&quot;</span>);</div>
<div class="line">  Network::connect(<span class="stringliteral">&quot;/tutorial/target/out&quot;</span>,<span class="stringliteral">&quot;/tutorial/target/in&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  Property options;</div>
<div class="line">  options.put(<span class="stringliteral">&quot;device&quot;</span>, <span class="stringliteral">&quot;remote_controlboard&quot;</span>);</div>
<div class="line">  options.put(<span class="stringliteral">&quot;local&quot;</span>, <span class="stringliteral">&quot;/tutorial/motor/client&quot;</span>);</div>
<div class="line">  options.put(<span class="stringliteral">&quot;remote&quot;</span>, <span class="stringliteral">&quot;/icubSim/head&quot;</span>);</div>
<div class="line">  PolyDriver robotHead(options);</div>
<div class="line">  <span class="keywordflow">if</span> (!robotHead.isValid()) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Cannot connect to robot head\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line">  IControlMode     *mod;</div>
<div class="line">  IPositionControl *pos;</div>
<div class="line">  IVelocityControl *vel;</div>
<div class="line">  IEncoders *enc;</div>
<div class="line">  robotHead.view(mod);</div>
<div class="line">  robotHead.view(pos);</div>
<div class="line">  robotHead.view(vel);</div>
<div class="line">  robotHead.view(enc);</div>
<div class="line">  <span class="keywordflow">if</span> (pos==NULL || vel==NULL || enc==NULL) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Cannot get interface to robot head\n&quot;</span>);</div>
<div class="line">    robotHead.close();</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a> = 0;</div>
<div class="line">  pos-&gt;getAxes(&amp;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line">  Vector setpoints;</div>
<div class="line">  setpoints.resize(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// enable velocity control mode</span></div>
<div class="line">  vector&lt;int&gt; modes(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>,VOCAB_CM_VELOCITY);</div>
<div class="line">  mod-&gt;setControlModes(modes.data());</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (1) { <span class="comment">// repeat forever</span></div>
<div class="line">    Vector *target = targetPort.read();  <span class="comment">// read a target</span></div>
<div class="line">    <span class="keywordflow">if</span> (target!=NULL) { <span class="comment">// check we actually got something</span></div>
<div class="line">       printf(<span class="stringliteral">&quot;We got a vector containing&quot;</span>);</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;target-&gt;size(); i++) {</div>
<div class="line">         printf(<span class="stringliteral">&quot; %g&quot;</span>, (*target)[i]);</div>
<div class="line">       }</div>
<div class="line">       printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">       <span class="keywordtype">double</span> <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a> = (*target)[0];</div>
<div class="line">       <span class="keywordtype">double</span> <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a> = (*target)[1];</div>
<div class="line">       <span class="keywordtype">double</span> conf = (*target)[2];</div>
<div class="line"> </div>
<div class="line">       <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a> -= 320/2;</div>
<div class="line">       <a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a> -= 240/2;</div>
<div class="line"> </div>
<div class="line">       <span class="keywordtype">double</span> vx = <a class="code" href="compute__ekf__sym_8m.html#abe119338ba11d7fd166333a3941bc2c4">x</a>*0.1;</div>
<div class="line">       <span class="keywordtype">double</span> vy = -<a class="code" href="show__eyes__axes_8m.html#a2fb1c5cf58867b5bbc9a1b145a86f3a0">y</a>*0.1;</div>
<div class="line"> </div>
<div class="line">       <span class="comment">/* prepare command */</span></div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">         setpoints[i] = 0;</div>
<div class="line">       }</div>
<div class="line"> </div>
<div class="line">       <span class="keywordflow">if</span> (conf&gt;0.5) {</div>
<div class="line">         setpoints[3] = vy;</div>
<div class="line">         setpoints[4] = vx;</div>
<div class="line">       } <span class="keywordflow">else</span> {</div>
<div class="line">         setpoints[3] = 0;</div>
<div class="line">         setpoints[4] = 0;</div>
<div class="line">       }</div>
<div class="line">       vel-&gt;velocityMove(setpoints.data());</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>See code at:</p>
<p><a class="el" href="findLocation_8cpp.html">src/imageProcessing/findLocation.cpp</a> <a class="el" href="lookAtLocation_8cpp.html">src/imageProcessing/lookAtLocation.cpp</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 26 2024 16:02:19 for iCub-main by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
