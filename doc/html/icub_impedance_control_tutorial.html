<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iCub-main: Getting accustomed with torque/impedance interfaces</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iCub-main
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Getting accustomed with torque/impedance interfaces </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial shows how to use the following interfaces:</p>
<p>yarp::dev::IControlMode</p>
<p>yarp::dev::ITorqueControl</p>
<p>yarp::dev::IImpedanceControl</p>
<p>yarp::dev::IInteractionControl</p>
<h1><a class="anchor" id="sec_intro"></a>
Introduction</h1>
<p>Prerequisites, see <a class="el" href="icub_motor_control_tutorial.html">Getting accustomed with motor interfaces</a></p>
<p>The code described in this tutorial can be found at <a class="el" href="tutorial__arm__joint__impedance_8cpp.html">src/motorControlImpedance/tutorial_arm_joint_impedance.cpp</a> <br  />
The example is based on the previous tutorial <a class="el" href="tutorial__arm_8cpp.html">src/motorControlBasic/tutorial_arm.cpp</a></p>
<p>The example shows how to open the ITorqueControl to show the arm joint torques and how to change the control mode of the elbow joint from position to impedance control.</p>
<p>A detailed reference of the yarp interfaces used in this tutorial (IControlMode, ITorqueControl, IImpedanceControl, IInteractionControl) can be found <a href="http://wiki.icub.org/yarpdoc/namespaceyarp_1_1dev.html">in the YARP doxygen documentation</a> and in the <a href="http://wiki.icub.org/wiki/File:ICub_Control_Modes_1_1.pdf">YARP Control Modes documentation</a>.</p>
<h1><a class="anchor" id="sec_initialization"></a>
Initialization</h1>
<p>Let us assume the module <a class="el" href="classwholeBodyDynamics.html">wholeBodyDynamics</a> is up and running. The <a class="el" href="classwholeBodyDynamics.html">wholeBodyDynamics</a> module, based on the <a class="el" href="group__iDyn.html">iDyn</a> library acts as a server and is responsibile for the calculation of the joint torques. In order to access to the torque values, our program has to declare and open the yarp ITorqueControl interface, in the same manner as you open the IPositionControl interface (see previous tutorial: <a class="el" href="icub_motor_control_tutorial.html">Getting accustomed with motor interfaces</a>). We can also open the IControlMode interface (resposibile to set the control mode of each joint (position/velocity/impedance etc.), the IImpedanceControl interface, used to set the impedance parameters (joint stiffness/ joint damping etc) and the IInteractionControl interface, used to set a joint in stiff or compliant interaction mode.</p>
<div class="fragment"><div class="line">IPositionControl *pos;</div>
<div class="line">IEncoders *<a class="code" href="namespacepython-motor-control.html#aa4a312653eff9f950af80bbf61a3d925">encs</a>;</div>
<div class="line">IControlMode *ictrl;</div>
<div class="line">IInteractionMode *iint;</div>
<div class="line">IImpedanceControl *iimp;</div>
<div class="line">ITorqueControl *itrq;</div>
<div class="ttc" id="anamespacepython-motor-control_html_aa4a312653eff9f950af80bbf61a3d925"><div class="ttname"><a href="namespacepython-motor-control.html#aa4a312653eff9f950af80bbf61a3d925">python-motor-control.encs</a></div><div class="ttdeci">encs</div><div class="ttdef"><b>Definition:</b> <a href="python-motor-control_8py_source.html#l00036">python-motor-control.py:36</a></div></div>
</div><!-- fragment --><p>and:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a>;</div>
<div class="line"><a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = robotDevice.view(pos);</div>
<div class="line"><a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> &amp;&amp; robotDevice.view(<a class="code" href="namespacepython-motor-control.html#aa4a312653eff9f950af80bbf61a3d925">encs</a>);</div>
<div class="line"><a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> &amp;&amp; robotDevice.view(ictrl);</div>
<div class="line"><a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> &amp;&amp; robotDevice.view(iint);</div>
<div class="line"><a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> &amp;&amp; robotDevice.view(iimp);</div>
<div class="line"><a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> &amp;&amp; robotDevice.view(itrq);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (!ok) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Problems acquiring interfaces\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aWholeBodyPlayerModule_8h_html_a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6"><div class="ttname"><a href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">state::ok</a></div><div class="ttdeci">@ ok</div></div>
</div><!-- fragment --><p>We can thus start with checking how many axes we can control by doing:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a> = 0;</div>
<div class="line">pos-&gt;getAxes(&amp;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="ttc" id="aicub-main_2src_2tools_2simpleClient_2main_8cpp_html_aac40ef34e7573177f3e908c5195594a6"><div class="ttname"><a href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a></div><div class="ttdeci">int jnts</div><div class="ttdef"><b>Definition:</b> <a href="icub-main_2src_2tools_2simpleClient_2main_8cpp_source.html#l00060">main.cpp:60</a></div></div>
</div><!-- fragment --><p>Let's create some vectors for later use: </p><div class="fragment"><div class="line">Vector <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>;</div>
<div class="line">Vector encoders;</div>
<div class="line">Vector command_position;</div>
<div class="line">Vector command_velocity;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>.resize(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line">encoders.resize(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line">...</div>
<div class="ttc" id="anamespacepython-motor-control_html_aa48897549d21fee7c0824a33753804e2"><div class="ttname"><a href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">python-motor-control.tmp</a></div><div class="ttdeci">tmp</div><div class="ttdef"><b>Definition:</b> <a href="python-motor-control_8py_source.html#l00043">python-motor-control.py:43</a></div></div>
</div><!-- fragment --><p>Let's now initialize the controllers and start up the amplifiers:</p>
<div class="fragment"><div class="line"><span class="comment">// we need to set reference accelerations used to generate the velocity</span></div>
<div class="line"><span class="comment">// profile, here 50 degrees/sec^2</span></div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">    <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>[i] = 50.0;</div>
<div class="line">}</div>
<div class="line">pos-&gt;setRefAccelerations(<a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>.data());</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">    <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>[i] = 10.0;</div>
<div class="line">    pos-&gt;setRefSpeed(i, <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>[i]);</div>
<div class="line">}</div>
</div><!-- fragment --><p>if needed we can check the position of our axes by doing:</p>
<div class="fragment"><div class="line">enc-&gt;getEncoders(encoders.data());</div>
</div><!-- fragment --><p>which reads the values of the motor encoders into a vector of doubles of size ''jnts''.</p>
<h1><a class="anchor" id="sec_position"></a>
Position control</h1>
<p>First do: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">    <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>[i] = 40.0;</div>
<div class="line">}</div>
<div class="line">pos-&gt;setRefSpeeds(<a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>.data());</div>
</div><!-- fragment --><p>which sets the reference speed for all axes to 40 degrees per second. The reference speed is used to interpolate the trajectory between the current and the desired position.</p>
<p>Now you can do: </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = pos-&gt;positionMove(command_position.data());</div>
</div><!-- fragment --><p>where ''command_position'' is the desired position. This starts a movement of all axes toward the desired position.</p>
<h1><a class="anchor" id="sec_torque_reading"></a>
Reading the torques of a joint</h1>
<p>You can use the ITorqueControl interface to read the torque at a specific joint. </p><div class="fragment"><div class="line">Vector torques;</div>
<div class="line">torques.resize(nj);</div>
<div class="line">itrq-&gt;getTorques(torques.data());</div>
</div><!-- fragment --><h1><a class="anchor" id="sec_impedance"></a>
Using different control modes:  Position Control</h1>
<p>You can change the impedence parameters of a joint at any time: </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> stiffness = 0.111;          <span class="comment">// stiffness coefficient, units are Nm/deg</span></div>
<div class="line"><span class="keywordtype">double</span> damping =  0.014;           <span class="comment">// damping coefficient,   units are Nm/(deg/s)</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = iimp-&gt;setImpedance(joint, stiffness, damping);</div>
</div><!-- fragment --><p>You can use IInteractionMode interface to change the interaction mode of a specific joint to compliant interaction mode:</p>
<div class="fragment"><div class="line">ictrl-&gt;setPositionMode(3);</div>
<div class="line">iint-&gt;setInteractionMode(3,VOCAB_IM_COMPLIANT);</div>
</div><!-- fragment --><p>When in position control mode with compliant interaction mode, the low level controller (DSP) computes a refence torque Td as:</p>
<p class="formulaDsp">
\[ T_d = K_{spring} * (q_d-q) - K_{damp} * \dot{q} + F_{offset} \]
</p>
<p>which is tracked by the internal PID regulator.</p>
<p>You can specify a new equilibrium position using the usual position interface, because the control mode of the joint is still VOCAB_CM_POSITION even if the interaction mode has changed:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = pos-&gt;positionMove(command_position.data());</div>
</div><!-- fragment --><p>If you need to change the interaction mode back to stiff mode:</p>
<div class="fragment"><div class="line">iint-&gt;setInteractionMode(3,VOCAB_IM_COMPLIANT);</div>
</div><!-- fragment --><p>An ImpedanceVelocity control mode is also available. In this control modality you can use vel-&gt;VelocityMove() command in order to command a velocity while mantaining the impedance specified with the iimp-&gt;setImpedance(joint, stiffness, damping, dorce_offset) command.</p>
<h1><a class="anchor" id="sec_torque_control"></a>
Using different control modes: Torque Control</h1>
<p>Torque control mode can be used to directly specify a reference torque at a joint.</p>
<div class="fragment"><div class="line">ictrl-&gt;setTorqueMode(jnt);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> jnt_torque= 0.0; <span class="comment">//expressed in Nm</span></div>
<div class="line">itrq-&gt;setRefTorque(jnt_torque); </div>
</div><!-- fragment --><p>The gains of the PID controller resposibile of tracking the torque reference can be obtained using ITorqueControl::getTorquePid() method.</p>
<p>NOTE: the reference torque that you can specify on the icub joints is limited (clamped) to a given value. You can check this value in the yarprobotinterface configuration files for your robot.</p>
<p>NOTE2: near the hardware limits of the robot, the torque PID controlled is disabled, in order to prevent to command a torque againts the hardware limits. The PID controller is automatically re-enabled as soon as the joint is moved far the limits (You can view the value of the limites using the IControlLimits interface).</p>
<p>NOTE3: during calibration/parking of the robot, yarprobotinterface automatically sets the control mode of all the joints to position control mode with stiff interaction mode.</p>
<p>NOTE4: If your application changes the control mode/interaction mode of one joint, it's good practice to reset it to the previous modality when your application quits.</p>
<h1><a class="anchor" id="sec_closing"></a>
Closing the device</h1>
<p>When you are done with controlling the robot don't forget to close the device: </p><div class="fragment"><div class="line">robotDevice.close();</div>
</div><!-- fragment --><h1><a class="anchor" id="sec_more_interfaces"></a>
More interfaces</h1>
<p>To read more about the interfaces that are available in YARP read the <a href="http://wiki.icub.org/yarpdoc/namespaceyarp_1_1dev.html">doxygen online documentation</a> and in the <a href="http://wiki.icub.org/wiki/File:ICub_Control_Modes_1_1.pdf">YARP Control Modes documentation</a>.</p>
<h1><a class="anchor" id="sec_code"></a>
Code</h1>
<p>See code in: <a class="el" href="tutorial__arm__joint__impedance_8cpp.html">src/motorControlImpedance/tutorial_arm_joint_impedance.cpp</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 26 2024 16:02:19 for iCub-main by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
