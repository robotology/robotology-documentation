<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iCub-main: Getting accustomed with motor interfaces</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iCub-main
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Getting accustomed with motor interfaces </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial shows how to get interfaces to control the arm.</p>
<h1><a class="anchor" id="sec_intro"></a>
Introduction</h1>
<p>Motor control in YARP is done through a motor control device.</p>
<p>The code in this tutorial is a good example to start playing with motor control. This example uses a remoted device driver which exports exactly the same interfaces of the actual device driver (only initialization is different). The main difference between the two is in terms of efficiency, if you're developing a low-level control loop you might want to be local, on the other hand a simple sporadic position control can be effected through the remote device driver. Let's assume we have started the server side already (e.g. the simulator).</p>
<h1><a class="anchor" id="sec_initialization"></a>
Initialization</h1>
<p>Let us assume the simulator is up and running.</p>
<p>In practice, we start by preparing a set of configuration parameters:</p>
<div class="fragment"><div class="line">Property options;</div>
<div class="line">options.put(<span class="stringliteral">&quot;device&quot;</span>, <span class="stringliteral">&quot;remote_controlboard&quot;</span>);</div>
<div class="line">options.put(<span class="stringliteral">&quot;local&quot;</span>, <span class="stringliteral">&quot;/test/client&quot;</span>);                 <span class="comment">//local port names</span></div>
<div class="line">options.put(<span class="stringliteral">&quot;remote&quot;</span>, <span class="stringliteral">&quot;/icubSim/right_arm&quot;</span>);         <span class="comment">//where we connect to</span></div>
</div><!-- fragment --><p>where the ''local'' and ''remote'' parameters are used to set the port names for the connection to the server side. In our example this means that the process will create the following (local) ports:</p>
<div class="fragment"><div class="line">/test/client/<a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104ab">state</a>:i</div>
<div class="line">/test/client/command:o</div>
<div class="line">/test/client/rpc:o</div>
<div class="ttc" id="aWholeBodyPlayerModule_8h_html_a055865842672bfeb446ff98a1e9104ab"><div class="ttname"><a href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104ab">state</a></div><div class="ttdeci">state</div><div class="ttdef"><b>Definition:</b> <a href="WholeBodyPlayerModule_8h_source.html#l00064">WholeBodyPlayerModule.h:64</a></div></div>
</div><!-- fragment --><p>And will automatically connect them to the server, on the following (remote) ports (we assume here that the server created those ports correctly):</p>
<div class="fragment"><div class="line">/icubSim/right_arm/<a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104ab">state</a>:o</div>
<div class="line">/icubSim/right_arm/command:i</div>
<div class="line">/icubSim/right_arm/rpc:i</div>
</div><!-- fragment --><p>To create the driver we use the PolyDriver:</p>
<div class="fragment"><div class="line">PolyDriver robotDevice(options);</div>
<div class="line"><span class="keywordflow">if</span> (!robotDevice.isValid()) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Device not available.  Here are the known devices:\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s&quot;</span>, Drivers::factory().<a class="code" href="namespaceiCub_1_1skinManager.html#a34046cbbd9cb77d15cb2d25870c0ee03">toString</a>().c_str());</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceiCub_1_1skinManager_html_a34046cbbd9cb77d15cb2d25870c0ee03"><div class="ttname"><a href="namespaceiCub_1_1skinManager.html#a34046cbbd9cb77d15cb2d25870c0ee03">iCub::skinManager::toString</a></div><div class="ttdeci">std::string toString(const T &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="compensator_8h_source.html#l00200">compensator.h:200</a></div></div>
</div><!-- fragment --><p>which instantiates the driver. If the parameters are correct and the server side has been prepared the local driver also connects to the remote one. The next step is to get a set of interfaces (pointers to) to work with, for example:</p>
<div class="fragment"><div class="line">IPositionControl *pos;</div>
<div class="line">IVelocityControl *vel;</div>
<div class="line">IEncoders *enc;</div>
</div><!-- fragment --><p>and:</p>
<div class="fragment"><div class="line">robotDevice.view(pos);</div>
<div class="line">robotDevice.view(vel);</div>
<div class="line">robotDevice.view(enc);</div>
</div><!-- fragment --><p>if everything went ok the pointers are valid pointers (check it!). For example: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (pos==0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Error getting IPositionControl interface.\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We can thus start with checking how many axes we can control by doing:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a> = 0;</div>
<div class="line">pos-&gt;getAxes(&amp;<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="ttc" id="aicub-main_2src_2tools_2simpleClient_2main_8cpp_html_aac40ef34e7573177f3e908c5195594a6"><div class="ttname"><a href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a></div><div class="ttdeci">int jnts</div><div class="ttdef"><b>Definition:</b> <a href="icub-main_2src_2tools_2simpleClient_2main_8cpp_source.html#l00060">main.cpp:60</a></div></div>
</div><!-- fragment --><p>Let's create some vectors for later use: </p><div class="fragment"><div class="line">Vector <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>;</div>
<div class="line">Vector encoders;</div>
<div class="line">Vector command_position;</div>
<div class="line">Vector command_velocity;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>.resize(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line">encoders.resize(<a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>);</div>
<div class="line">...</div>
<div class="ttc" id="anamespacepython-motor-control_html_aa48897549d21fee7c0824a33753804e2"><div class="ttname"><a href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">python-motor-control.tmp</a></div><div class="ttdeci">tmp</div><div class="ttdef"><b>Definition:</b> <a href="python-motor-control_8py_source.html#l00043">python-motor-control.py:43</a></div></div>
</div><!-- fragment --><p>Let's now initialize the controllers and start up the amplifiers:</p>
<div class="fragment"><div class="line"><span class="comment">/* we need to set reference accelerations used to generate the velocity */</span></div>
<div class="line"><span class="comment">/* profile, here 50 degrees/sec^2 */</span></div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">    <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>[i] = 50.0;</div>
<div class="line">}</div>
<div class="line">pos-&gt;setRefAccelerations(<a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>.data());</div>
</div><!-- fragment --><p>if needed we can check the position of our axes by doing:</p>
<div class="fragment"><div class="line">enc-&gt;getEncoders(encoders.data());</div>
</div><!-- fragment --><p>which reads the values of the motor encoders into a vector of doubles of size ''jnts''.</p>
<p>Important: check the return value of this function to ensure that communication with the robot is sane and that the function can return updated values.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> ret=enc-&gt;getEncoders(encoders.data());</div>
<div class="line"><span class="keywordflow">if</span> (!ret)</div>
<div class="line">{</div>
<div class="line">     <a class="code" href="saveNetwork_8m.html#a0eba6f64b9c26507a877bcb0c4f270e2">fprintf</a>(stderr, <span class="stringliteral">&quot;Error reading encoders, check connectivity with the robot\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">     <span class="comment">/* use encoders */</span></div>
<div class="line">}</div>
<div class="ttc" id="asaveNetwork_8m_html_a0eba6f64b9c26507a877bcb0c4f270e2"><div class="ttname"><a href="saveNetwork_8m.html#a0eba6f64b9c26507a877bcb0c4f270e2">fprintf</a></div><div class="ttdeci">fprintf(fid,'\n')</div></div>
</div><!-- fragment --><h1><a class="anchor" id="sec_position"></a>
Position control</h1>
<p>First do: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="icub-main_2src_2tools_2simpleClient_2main_8cpp.html#aac40ef34e7573177f3e908c5195594a6">jnts</a>; i++) {</div>
<div class="line">    <a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>[i] = 40.0;</div>
<div class="line">}</div>
<div class="line">pos-&gt;setRefSpeeds(<a class="code" href="namespacepython-motor-control.html#aa48897549d21fee7c0824a33753804e2">tmp</a>.data());</div>
</div><!-- fragment --><p>which sets the reference speed for all axes to 40 degrees per second. The reference speed is used to interpolate the trajectory between the current and the desired position.</p>
<p>Now you can do: </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = pos-&gt;positionMove(command_position.data());</div>
<div class="ttc" id="aWholeBodyPlayerModule_8h_html_a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6"><div class="ttname"><a href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">state::ok</a></div><div class="ttdeci">@ ok</div></div>
</div><!-- fragment --><p>where ''command_position'' is the desired position. This starts a movement of all axes toward the desired position.</p>
<h1><a class="anchor" id="sec_velocity"></a>
Velocity control</h1>
<p>To send velocity commands do: </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="WholeBodyPlayerModule_8h.html#a055865842672bfeb446ff98a1e9104aba444bcb3a3fcf8389296c49467f27e1d6">ok</a> = vel-&gt;velocityMove(command_velocity.data());</div>
</div><!-- fragment --><p>which accelerates all axes to the velocity described by the vector ''command_velocity'' (in degrees per second).</p>
<h1><a class="anchor" id="sec_closing"></a>
Closing the device</h1>
<p>When you are done with controlling the robot don't forget to close the device: </p><div class="fragment"><div class="line">robotDevice.close();</div>
</div><!-- fragment --><h1><a class="anchor" id="sec_more_interfaces"></a>
More interfaces</h1>
<p>To read more about the interfaces that are available in YARP read the online documentation: <a href="http://eris.liralab.it/yarpdoc/namespaceyarp_1_1dev.html">http://eris.liralab.it/yarpdoc/namespaceyarp_1_1dev.html</a></p>
<h1><a class="anchor" id="sec_code"></a>
Code</h1>
<p>See code in: <a class="el" href="tutorial__arm_8cpp.html">src/motorControlBasic/tutorial_arm.cpp</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 26 2024 16:02:19 for iCub-main by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
