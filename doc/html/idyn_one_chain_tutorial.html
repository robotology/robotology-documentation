<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iCub-main: Computation of torques in a single chain, using iDyn</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iCub-main
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Computation of torques in a single chain, using iDyn </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this tutorial we show how to compute the joint torques in a single kinematic chain, using the iDyn library.</p>
<p>Before you read this tutorial you should at least get accustomed with the iDyn library, and the basic of Newton-Euler algorithm (reading the <a class="el" href="idyn_introduction.html">short introduction to iDyn</a> might be useful).</p>
<p>Remember to include YARP and <a class="el" href="namespaceiCub.html" title="This file contains the definition of unique IDs for the body parts and the skin parts of the robot.">iCub</a> as packages, and to link iDyn library in CMakeLists.txt: </p><div class="fragment"><div class="line">FIND_PACKAGE(YARP)</div>
<div class="line">FIND_PACKAGE(ICUB)</div>
<div class="line">...                                                                     </div>
<div class="line">TARGET_LINK_LIBRARIES(${PROJECTNAME} iDyn ${YARP_LIBRARIES})</div>
</div><!-- fragment --><p> note that in this case we need to look for the packages because we are developing a tutorial which is outside <a class="el" href="namespaceiCub.html" title="This file contains the definition of unique IDs for the body parts and the skin parts of the robot.">iCub</a> project.</p>
<p>Using iDyn classes, vectors and matrices are used all the times. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;yarp/sig/Vector.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;yarp/sig/Matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="iDyn_8h.html">iCub/iDyn/iDyn.h</a>&gt;</span></div>
<div class="line">...</div>
<div class="line">using <span class="keyword">namespace </span>yarp::sig;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceiCub_1_1iDyn.html">iCub::iDyn</a>;</div>
<div class="ttc" id="aiDyn_8h_html"><div class="ttname"><a href="iDyn_8h.html">iDyn.h</a></div></div>
<div class="ttc" id="anamespaceiCub_1_1iDyn_html"><div class="ttname"><a href="namespaceiCub_1_1iDyn.html">iCub::iDyn</a></div><div class="ttdef"><b>Definition:</b> <a href="iDyn_8h_source.html#l00081">iDyn.h:82</a></div></div>
</div><!-- fragment --><p>We start creating a iDyn::iCubArmDyn, that is a chain with arm and torso links. If you are familiar with iKin, it is exactly the same limb type, with the same kinematic properties of a iCubArm. Of course, iCubArmDyn is more complete, since it basically inherits the kinematics and provides the dynamics. </p><div class="fragment"><div class="line">iCubArmDyn armTorsoDyn(<span class="stringliteral">&quot;right&quot;</span>);</div>
</div><!-- fragment --><p>By default in iCubArmDyn the torso is blocked, as it is in its corresponding iKin limb, iCubArm; we unblock it, so we can also use the torso links. Note that releasing the links we have N==DOF (i.e. the number of links equal to the number of degrees of freedom). </p><div class="fragment"><div class="line">armTorsoDyn.releaseLink(0);</div>
<div class="line">armTorsoDyn.releaseLink(1);</div>
<div class="line">armTorsoDyn.releaseLink(2);</div>
</div><!-- fragment --><p>Before any computation, we must prepare the necessary variables and put them in the chain model. First of all, we must set the joint angles in the limb model: in dynamics, we need joint positions, velocities and accelerations.</p>
<div class="fragment"><div class="line">Vector q(armTorsoDyn.getN()); q.zero();</div>
<div class="line">Vector dq(q); Vector ddq(q);</div>
</div><!-- fragment --><p>In <a class="el" href="namespaceiCub.html" title="This file contains the definition of unique IDs for the body parts and the skin parts of the robot.">iCub</a> we only have position measurements from the encoders, so in order to avoid noisy values on velocity and acceleration, we suggest to apply at least a linear filter on the velocity data computed by differentiation, and a quadratic filter on the acceleration data. As a suggestion, look for adaptWinPolyEstimator in the ctrlLib, or have a look at the module WholeBodyTorqueObserver. Note that if the joint angles exceed the joint limits, their value is saturated to their min/max value automatically (as in iKin). At the moment there's not such a limitation for velocities and accelerations. It must be reminded that the joint limits could be different in the real robot, so it is always a good practice, when using the robot, to call the <em>alignJointsBound</em> method, which queries the robot for the real joints limits.</p>
<div class="fragment"><div class="line">armTorsoDyn.setAng(q);</div>
<div class="line">armTorsoDyn.setDAng(dq);</div>
<div class="line">armTorsoDyn.setD2Ang(ddq);</div>
</div><!-- fragment --><p>In order to initialize the kinematic phase of Newton-Euler algorithm, we need the kinematic informations to be set in the base of the chain, where the base is intended to be the first link (first w.r.t the Denavit Hartenberg convention for describing the links, so the torso base in iCubArmDyn). If the robot is fixed and not moving, everything can be simply set to zero: but remember to provide the gravity information!</p>
<div class="fragment"><div class="line">Vector w0(3); Vector dw0(3); Vector ddp0(3);</div>
<div class="line">w0=dw0=ddp0=0.0; ddp0[2]=9.81;</div>
</div><!-- fragment --><p>The end-effector external wrench (force/moment), is necessary to initialize the wrench phase of the Newton-Euler algorithm. If the robot is not touching anything, the external wrench is zero by default. If there's contact... look at the WrenchObserver module.</p>
<div class="fragment"><div class="line">Vector Fend(3); Fend.zero();</div>
<div class="line">Vector Muend(Fend);</div>
</div><!-- fragment --><p>We can now start using iDyn. In order to perform the kinematic and wrench computation in a chain, we must first tell the limb that we want to use the iDyn::RecursiveNewtonEuler library, by calling a "prepare" method. In fact, before using our method, a new chain, parallel to the iDynChain, is built: it is a OneChainNewtonEuler, and it is made of OneLinkNewtonEuler virtual links, each having its "real" corresponding iDynLink; in addition, a BaseLink and a FinalLink elements are added to the chain, defining the entry points for the kinematic and wrench phases of Newton-Euler computations.</p>
<p>The reason of the existence of the <em>prepareNewtonEuler</em> method is twofold:</p><ol type="1">
<li>one can use a iDynLimb without dynamics, since it includes the kinematics of iKin for example one may only want to set joint angles and compute the jacobian</li>
<li>one may prefer to use its own dynamic library to compute internal forces/torques, and not necessarily the Newton-Euler one we provide.</li>
</ol>
<p>When calling <em>prepareNewtonEuler()</em>, we must specify the type of computations we want to perform, which are basically:</p>
<ul>
<li>STATIC: we only need q (joints positions)</li>
<li>DYNAMIC: we need q,dq,ddq (joints position, velocity, acceleration) --&gt; default</li>
</ul>
<div class="fragment"><div class="line">armTorsoDyn.prepareNewtonEuler(<a class="code" href="namespaceiCub_1_1iDyn.html#a6b03dffbe5b7a4931b1d7afeff96b362ac034feb4663b0e2591e629606ef5e2f3">DYNAMIC</a>);</div>
<div class="ttc" id="anamespaceiCub_1_1iDyn_html_a6b03dffbe5b7a4931b1d7afeff96b362ac034feb4663b0e2591e629606ef5e2f3"><div class="ttname"><a href="namespaceiCub_1_1iDyn.html#a6b03dffbe5b7a4931b1d7afeff96b362ac034feb4663b0e2591e629606ef5e2f3">iCub::iDyn::DYNAMIC</a></div><div class="ttdeci">@ DYNAMIC</div><div class="ttdef"><b>Definition:</b> <a href="iDynInv_8h_source.html#l00064">iDynInv.h:64</a></div></div>
</div><!-- fragment --><p>Finally we perform the computations, by calling a single function which performs autonomously:</p><ol type="1">
<li>Initialization of both phases</li>
<li>Kinematic Phase</li>
<li>Wrench Phase</li>
</ol>
<div class="fragment"><div class="line">armTorsoDyn.computeNewtonEuler(w0,dw0,ddp0,Fend,Muend);</div>
</div><!-- fragment --><p>We can now retrieve the results: forces, moments and joint torques. In particular, F and M are 3xN matrices, where the i-th column is the i-th force/moment (each having 3 components), whereas Tau is a 1xN vector, since the joint torque is a scalar number.</p>
<div class="fragment"><div class="line">Matrix <a class="code" href="compute__ekf__fast_8m.html#a1fd406685cbdee605d0a7bebed56fdb0">F</a> = armTorsoDyn.getForces();</div>
<div class="line">Matrix Mu = armTorsoDyn.getMoments();</div>
<div class="line">Vector Tau = armTorsoDyn.getTorques();</div>
<div class="ttc" id="acompute__ekf__fast_8m_html_a1fd406685cbdee605d0a7bebed56fdb0"><div class="ttname"><a href="compute__ekf__fast_8m.html#a1fd406685cbdee605d0a7bebed56fdb0">F</a></div><div class="ttdeci">F</div><div class="ttdef"><b>Definition:</b> <a href="compute__ekf__fast_8m_source.html#l00022">compute_ekf_fast.m:22</a></div></div>
</div><!-- fragment --><p>Full working code of this tutorial is available here: </p><div class="fragment"><div class="line">icub-tutorials/src/iDyn/oneChainDynamics/<a class="code" href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>.cpp</div>
<div class="ttc" id="aicub-main_2src_2core_2emotionInterface_2main_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="icub-main_2src_2core_2emotionInterface_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition:</b> <a href="icub-main_2src_2core_2emotionInterface_2main_8cpp_source.html#l00031">main.cpp:31</a></div></div>
</div><!-- fragment --><dl class="section author"><dt>Author</dt><dd>Serena Ivaldi </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 26 2024 16:02:19 for iCub-main by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
